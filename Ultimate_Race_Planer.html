<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ultimate Race Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind (layout utility only; main "HUD" look is custom CSS below) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts (HUD-ish) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --bg: #05070c;
      --panel: rgba(12, 16, 26, 0.92);
      --panel2: rgba(9, 12, 20, 0.92);
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.16);
      --txt: rgba(235, 245, 255, 0.92);
      --muted: rgba(180, 200, 220, 0.62);

      --lime: #7CFF5B;   /* PUSH */
      --mag:  #FF38D1;   /* NORMAL */
      --cyan: #36D7FF;   /* SAVE */
      --amber:#FFC857;
      --red:  #FF3B3B;

      --shadow: 0 12px 40px rgba(0,0,0,0.65);
      --glowL: 0 0 18px rgba(124,255,91,0.22);
      --glowM: 0 0 18px rgba(255,56,209,0.22);
      --glowC: 0 0 18px rgba(54,215,255,0.22);
    }

    body{
      margin: 0;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(54,215,255,0.16), transparent 55%),
                  radial-gradient(1100px 700px at 85% 10%, rgba(255,56,209,0.10), transparent 55%),
                  radial-gradient(1000px 700px at 50% 100%, rgba(124,255,91,0.08), transparent 55%),
                  var(--bg);
      color: var(--txt);
      font-family: Rajdhani, system-ui, -apple-system, Segoe UI, sans-serif;
      letter-spacing: 0.2px;
    }

    /* HUD cards */
    .hud-card{
      background: linear-gradient(180deg, rgba(16,20,34,0.92), rgba(9,12,20,0.92));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .hud-card::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(90deg,
        rgba(54,215,255,0.10),
        rgba(255,56,209,0.08),
        rgba(124,255,91,0.08)
      );
      opacity: 0.25;
      mix-blend-mode: screen;
    }

    .hud-head{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.12));
    }
    .hud-title{
      font-family: Orbitron, Rajdhani, sans-serif;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 11px;
      color: rgba(235,245,255,0.78);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .hud-chip{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(0,0,0,0.35);
      color: rgba(235,245,255,0.82);
    }

    .hud-body{ position: relative; padding: 12px; }

    .hud-label{ font-size: 12px; color: var(--muted); }
    .hud-help{ font-size: 11px; color: rgba(180,200,220,0.55); }

    .hud-input, .hud-select, .hud-btn{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: rgba(235,245,255,0.92);
      padding: 8px 10px;
      outline: none;
      transition: 120ms ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    .hud-input:focus, .hud-select:focus{
      border-color: rgba(54,215,255,0.45);
      box-shadow: 0 0 0 3px rgba(54,215,255,0.18), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .hud-select option{
      background: #0b0f1a;
      color: rgba(235,245,255,0.92);
    }
    .hud-input[disabled], .hud-select[disabled]{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .hud-btn{
      font-family: Orbitron, sans-serif;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 9px 12px;
    }
    .btn-lime{ border-color: rgba(124,255,91,0.45); box-shadow: var(--glowL); }
    .btn-mag { border-color: rgba(255,56,209,0.45); box-shadow: var(--glowM); }
    .btn-cyan{ border-color: rgba(54,215,255,0.45); box-shadow: var(--glowC); }

    .btn-lime.active{ background: rgba(124,255,91,0.14); }
    .btn-mag.active { background: rgba(255,56,209,0.14); }
    .btn-cyan.active{ background: rgba(54,215,255,0.14); }

    .hud-grid{ display:grid; gap: 10px; }
    .hud-grid.cols2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .hud-grid.cols3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }

    .hud-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      font-size: 12px;
    }
    .hud-th{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(180,200,220,0.65);
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }
    .hud-td{
      padding: 8px 10px;
      border-top: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
    }
    .hud-td:first-child{
      border-left: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px 0 0 12px;
    }
    .hud-td:last-child{
      border-right: 1px solid rgba(255,255,255,0.08);
      border-radius: 0 12px 12px 0;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 11px;
      background: rgba(0,0,0,0.25);
      color: rgba(235,245,255,0.86);
    }
    .dot{ width: 8px; height: 8px; border-radius: 999px; display:inline-block; }

    /* Compound "chips" */
    .cmp-soft{ background: rgba(255,59,59,0.20) !important; border-color: rgba(255,59,59,0.45) !important; }
    .cmp-med { background: rgba(255,200,87,0.18) !important; border-color: rgba(255,200,87,0.45) !important; }
    .cmp-hard{ background: rgba(200,210,220,0.14) !important; border-color: rgba(200,210,220,0.35) !important; }
    .cmp-wet { background: rgba(54,215,255,0.16) !important; border-color: rgba(54,215,255,0.45) !important; }

    .warn{
      border: 1px solid rgba(255,200,87,0.35);
      background: rgba(255,200,87,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(255,230,170,0.95);
    }

    /* Fuel unit switch */
    .seg{
      display:flex;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(0,0,0,0.35);
    }
    .seg button{
      flex:1;
      padding: 8px 10px;
      font-family: Orbitron, sans-serif;
      font-size: 11px;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: none;
      background: transparent;
      color: rgba(235,245,255,0.82);
      cursor:pointer;
    }
    .seg button.active{
      background: rgba(54,215,255,0.10);
      box-shadow: inset 0 0 0 1px rgba(54,215,255,0.20);
      color: rgba(235,245,255,0.95);
    }

    @media (max-width: 1024px){
      .hud-grid.cols3{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState } = React;

    function RacePlanner() {
      /* ------------------------------------------------------------
         MODES (A/B/C) == PUSH/NORMAL/SAVE
         - Plan A = PUSH
         - Plan B = NORMAL
         - Plan C = SAVE
      -------------------------------------------------------------*/
      const MODE = {
        A: { key:"A", name:"PUSH",   colorVar:"--lime", btn:"btn-lime" },
        B: { key:"B", name:"NORMAL", colorVar:"--mag",  btn:"btn-mag"  },
        C: { key:"C", name:"SAVE",   colorVar:"--cyan", btn:"btn-cyan" },
      };

      /* ------------------------------------------------------------
         STATE / DEFAULTS
      -------------------------------------------------------------*/
      // Fuel unit
      const [fuelUnit, setFuelUnit] = useState("VE"); // "VE" or "L"

      // Tank is ALWAYS editable in liters
      const [tankLiters, setTankLiters] = useState(100);

      // Base consumption & buffer are stored in CURRENT fuelUnit
      const [baseUsePerLap, setBaseUsePerLap] = useState(4.5); // %/lap or L/lap
      const [fuelBuffer, setFuelBuffer] = useState(0.2);       // % or L

      // Lap time
      const [lapTimeStr, setLapTimeStr] = useState("4:00.000");
      const [lapTimeSec, setLapTimeSec] = useState(240);

      // Race duration
      const [raceDurationStr, setRaceDurationStr] = useState("24:00:00");
      const [raceDurationSec, setRaceDurationSec] = useState(86400);

      // Pit model
      const [basePit, setBasePit] = useState(25);
      const [tyreChangeTime, setTyreChangeTime] = useState(13);

      // Refuel rate is in seconds per CURRENT UNIT (%VE OR L)
      const [refuelRate, setRefuelRate] = useState(0.4);  // s/%VE or s/L

      const [inLapLoss, setInLapLoss] = useState(1.5);
      const [outLapLoss, setOutLapLoss] = useState(2.0);
      const [warmupLoss, setWarmupLoss] = useState(3.0);

      // Start penalty
      const [firstLapPenalty, setFirstLapPenalty] = useState(5.0);

      // Tyre deg
      const [tyreDeg, setTyreDeg] = useState(0.02);

      // Pace deltas for B/C relative to A
      const [paceDeltaB, setPaceDeltaB] = useState(0.5);
      const [paceDeltaC, setPaceDeltaC] = useState(1.0);

      // Compound deltas
      const [compoundDeltas, setCompoundDeltas] = useState({
        Soft: -0.5,
        Medium: 0.0,
        Hard: 0.5,
        Wet: 10.0
      });

      // Start times
      const [gameStart, setGameStart] = useState("12:00");
      const [utcStart,  setUtcStart]  = useState("14:00");

      // Selected plan A/B/C
      const [plan, setPlan] = useState("A");

      // Per-stint overrides (STORED PER PLAN so comparisons keep changes)
      const [tyreChanges, setTyreChanges] = useState({});        // key: "A-3" => bool (true=change)
      const [stintCompounds, setStintCompounds] = useState({});  // key: "A-3" => "Soft" etc (only when tyre change)
      const [driverNames, setDriverNames] = useState({});        // key: "A-3" => "Name"
      const [fuelSources, setFuelSources] = useState({});        // key: "A-3" => "A"|"B"|"C" (Push/Normal/Save)

      // Google Sheets help
      const [showGsHelp, setShowGsHelp] = useState(false);

      // Final stint strategy (keep as in original)
      const [finalStintMode, setFinalStintMode] = useState("pit");  // "pit" or "save"
      const [maxSavePercent, setMaxSavePercent] = useState(2);

      /* ------------------------------------------------------------
         HELPERS
      -------------------------------------------------------------*/
      const litersPerVE = Math.max(0.000001, tankLiters / 100); // liters per 1%VE

      const unitLabel = fuelUnit === "VE" ? "%VE" : "L";
      const unitPerLapLabel = fuelUnit === "VE" ? "%/lap" : "L/lap";
      const refuelLabel = fuelUnit === "VE" ? "s/%VE" : "s/L";

      const parseTime = (val) => {
        if (!val) return 0;
        const p = val.split(":").map(Number);
        if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
        if (p.length === 2) return p[0]*60 + p[1];
        return p[0];
      };

      const formatLap = (s) => {
        if (s <= 0) return "0:00.000";
        const m = Math.floor(s/60);
        const sec = (s % 60).toFixed(3).padStart(6,"0");
        return `${m}:${sec}`;
      };

      const timeToMin = (hhmm) => {
        const [h,m] = hhmm.split(":").map(Number);
        return h*60 + m;
      };

      const minToTime = (mins) => {
        const x = ((mins % 1440) + 1440) % 1440;
        const h = String(Math.floor(x/60)).padStart(2,"0");
        const m = String(x % 60).padStart(2,"0");
        return `${h}:${m}`;
      };

      const avgDegWithAge = (laps, deg, ageStart) => {
        if (laps <= 0 || deg <= 0) return 0;
        // average of ages: ageStart..ageStart+laps-1
        return deg * (2 * ageStart + (laps - 1)) / 2;
      };

      const compoundClass = (compound) => {
        switch (compound) {
          case "Soft":   return "cmp-soft";
          case "Medium": return "cmp-med";
          case "Hard":   return "cmp-hard";
          case "Wet":    return "cmp-wet";
          default:       return "";
        }
      };

      /* ------------------------------------------------------------
         FUEL UNIT SWITCH (VE <-> L) INCLUDING REFUEL RATE
      -------------------------------------------------------------*/
      const switchUnit = (toUnit) => {
        if (toUnit === fuelUnit) return;

        if (fuelUnit === "VE" && toUnit === "L") {
          // % -> L
          const factor = litersPerVE; // L per 1%VE
          setBaseUsePerLap((baseUsePerLap || 0) * factor);
          setFuelBuffer((fuelBuffer || 0) * factor);

          // refuel rate: s/% -> s/L  (time for 1 L = time for (1/factor)%)
          setRefuelRate((refuelRate || 0) / factor);
          setFuelUnit("L");
        } else {
          // L -> %
          const factor = litersPerVE;
          setBaseUsePerLap((baseUsePerLap || 0) / factor);
          setFuelBuffer((fuelBuffer || 0) / factor);

          // refuel rate: s/L -> s/%  (time for 1% = time for factor L)
          setRefuelRate((refuelRate || 0) * factor);
          setFuelUnit("VE");
        }
      };

      /* ------------------------------------------------------------
         INPUT HANDLERS
      -------------------------------------------------------------*/
      const handleLapTimeChange = (e) => {
        const v = e.target.value;
        setLapTimeStr(v);
        const s = parseTime(v);
        if (!Number.isNaN(s)) setLapTimeSec(s);
      };

      const handleRaceTimeChange = (e) => {
        const v = e.target.value;
        setRaceDurationStr(v);
        const s = parseTime(v);
        if (!Number.isNaN(s)) setRaceDurationSec(s);
      };

      /* ------------------------------------------------------------
         DERIVE BASE MODE PROFILES (A/B/C) from baseUsePerLap + buffer
         - They define BOTH fuel target and pace delta.
         - Fuel per lap targets are recalculated like original:
           compute PUSH stint laps = floor((usable)/baseUsePerLap)
           then target = usable / laps
           NORMAL = laps+1 target = usable/(laps+1)
           SAVE   = laps+2 target = usable/(laps+2)
      -------------------------------------------------------------*/
      const baseLapTime = lapTimeSec;

      const tankCapacityU = fuelUnit === "VE" ? 100 : tankLiters;
      const usableFuelU = Math.max(0, tankCapacityU - (fuelBuffer || 0));
      const baseUse = Math.max(0.000001, baseUsePerLap || 0.000001);

      const pushLaps = Math.max(1, Math.floor(usableFuelU / baseUse));
      const pushFuelTarget = usableFuelU / pushLaps;
      const pushPaceDelta = 0;

      const normalLaps = pushLaps + 1;
      const normalFuelTarget = usableFuelU / normalLaps;
      const normalPaceDelta = paceDeltaB;

      const saveLaps = pushLaps + 2;
      const saveFuelTarget = usableFuelU / saveLaps;
      const savePaceDelta = paceDeltaC;

      const modeConfig = (code) => {
        if (code === "A") return { laps: pushLaps, fuelTarget: pushFuelTarget, paceDelta: pushPaceDelta };
        if (code === "B") return { laps: normalLaps, fuelTarget: normalFuelTarget, paceDelta: normalPaceDelta };
        return { laps: saveLaps, fuelTarget: saveFuelTarget, paceDelta: savePaceDelta };
      };

      const fuelOptionLabel = (code) => {
        const cfg = modeConfig(code);
        const name = MODE[code].name;
        return `${name} (${cfg.fuelTarget.toFixed(2)} ${unitPerLapLabel})`;
      };

      /* ------------------------------------------------------------
         PER-STINT OVERRIDES (persist per plan)
      -------------------------------------------------------------*/
      const keyOf = (planCode, stintIndex) => `${planCode}-${stintIndex}`;

      const getTyreChange = (planCode, idx) => {
        const k = keyOf(planCode, idx);
        const override = tyreChanges[k];
        if (override !== undefined) return override;
        // default: no change on stint 1, change afterwards
        return idx === 1 ? false : true;
      };

      const toggleTyreChange = (planCode, stintIndex, currentLabel) => {
        const k = keyOf(planCode, stintIndex);
        setTyreChanges((prev) => ({ ...prev, [k]: currentLabel === "Yes" ? false : true }));
      };

      const setStintCompound = (planCode, stintIndex, value) => {
        const k = keyOf(planCode, stintIndex);
        setStintCompounds((prev) => ({ ...prev, [k]: value }));
      };

      const setStintDriver = (planCode, stintIndex, value) => {
        const k = keyOf(planCode, stintIndex);
        setDriverNames((prev) => ({ ...prev, [k]: value }));
      };

      const getFuelSource = (planCode, idx) => {
        const k = keyOf(planCode, idx);
        // default: use the plan’s own mode
        return fuelSources[k] || planCode;
      };

      const setFuelSource = (planCode, stintIndex, srcCode) => {
        const k = keyOf(planCode, stintIndex);
        setFuelSources((prev) => ({ ...prev, [k]: srcCode }));
      };

      /* ------------------------------------------------------------
         BUILD STINT OUTLINE
         - Fuel source per stint picks BOTH: fuel target AND pace delta (tied)
         - If tyreChange == No, compound carries over from previous stint (no manual)
         - Final stint solver uses same fuel source logic (default = plan if not set)
      -------------------------------------------------------------*/
      const buildPlanOutline = (planCode) => {
        const stdCfg = modeConfig(planCode);
        if (!stdCfg.laps || stdCfg.laps <= 0) return { rows: [], warning: "" };

        const rows = [];
        let usedTime = 0;
        let stintIdx = 1;

        let tyreSet = 1;
        let tyreAge = 0;
        let prevCompound = "Medium";

        const maxStints = 200;
        const minLap = Math.max(1, baseLapTime);
        const MAX_TANK = tankCapacityU;
        let warning = "";

        const getCompoundEffective = (idx, tyreChange, prev) => {
          if (idx === 1) {
            // first stint uses saved or default
            const saved = stintCompounds[keyOf(planCode, idx)];
            return saved || "Medium";
          }
          if (!tyreChange) {
            // carry over if no tyre change
            return prev;
          }
          const saved = stintCompounds[keyOf(planCode, idx)];
          return saved || "Medium";
        };

        const stintFuelProfile = (idx) => {
          const src = getFuelSource(planCode, idx); // "A"/"B"/"C"
          const cfg = modeConfig(src);
          return { src, fuelTarget: cfg.fuelTarget, paceDelta: cfg.paceDelta, lapsStd: stdCfg.laps };
        };

        // regular stints (full blocks) until we can't fit another full stint
        while (stintIdx <= maxStints) {
          const tyreChange = getTyreChange(planCode, stintIdx);
          const compound = getCompoundEffective(stintIdx, tyreChange, prevCompound);
          const compoundDelta = compoundDeltas[compound] ?? 0;

          const fuelProf = stintFuelProfile(stintIdx);

          const ageStart = (stintIdx === 1) ? 0 : (tyreChange ? 0 : tyreAge);

          const laps = fuelProf.lapsStd;
          const degPenalty = avgDegWithAge(laps, tyreDeg, ageStart);
          const lapTarget = baseLapTime + fuelProf.paceDelta + degPenalty + compoundDelta;

          const fuelUsed = laps * fuelProf.fuelTarget;

          let pit = 0;
          let outLossVal = 0;
          let inLossVal = inLapLoss;
          let startExtra = 0;

          if (stintIdx === 1) {
            pit = 0;
            startExtra = firstLapPenalty;
            outLossVal = 0;
          } else {
            const fuelTime = fuelUsed * refuelRate; // s/(unit) * units
            pit = basePit + fuelTime + (tyreChange ? tyreChangeTime : 0);
            outLossVal = outLapLoss + (tyreChange ? warmupLoss : 0);
          }

          const drive = laps * lapTarget;
          const block = pit + startExtra + outLossVal + drive + inLossVal;

          if (usedTime + block + minLap <= raceDurationSec) {
            // update tyre set + tyre age
            if (stintIdx === 1) tyreSet = tyreChange ? 2 : 1;
            else if (tyreChange) tyreSet += 1;

            tyreAge = (stintIdx === 1 || tyreChange) ? laps : (tyreAge + laps);
            prevCompound = compound;

            rows.push({
              stintIndex: stintIdx,
              label: `${stintIdx}`,
              fuelSource: fuelProf.src, // A/B/C
              fuelTarget: fuelProf.fuelTarget,
              fuelUsed,
              laps,
              lapTimeTarget: lapTarget,
              pitTime: pit,
              tyreChange: tyreChange ? "Yes" : "No",
              tyreSet,
              compound,
              blockSeconds: block,
              driveSeconds: drive,
              outPenaltySeconds: outLossVal
            });

            usedTime += block;
            stintIdx += 1;
          } else {
            break;
          }
        }

        // final stint (solver)
        const remaining = raceDurationSec - usedTime;
        const finalIdx = stintIdx;

        const tyreChangeFinal = getTyreChange(planCode, finalIdx);
        const finalCompound = getCompoundEffective(finalIdx, tyreChangeFinal, prevCompound);
        const finalDelta = compoundDeltas[finalCompound] ?? 0;

        let finalTyreSet = tyreSet;
        if (finalIdx === 1) finalTyreSet = tyreChangeFinal ? 2 : 1;
        else if (tyreChangeFinal) finalTyreSet += 1;

        const ageStartFinal = (finalIdx === 1) ? 0 : (tyreChangeFinal ? 0 : tyreAge);

        // final stint uses the same per-stint fuel source selector logic
        const finalFuelProf = (() => {
          const src = getFuelSource(planCode, finalIdx);
          const cfg = modeConfig(src);
          return { src, fuelTarget: cfg.fuelTarget, paceDelta: cfg.paceDelta, lapsStd: stdCfg.laps };
        })();

        const maxSearch = stdCfg.laps + 40;

        const searchWithFuelPerLap = (fuelPerLapX) => {
          let solution = null;
          let lastLegal = null;

          for (let L = 1; L <= maxSearch; L++) {
            const fuelU = L * fuelPerLapX;
            if (fuelU > MAX_TANK) break;

            const degP = avgDegWithAge(L, tyreDeg, ageStartFinal);
            const lapT = baseLapTime + finalFuelProf.paceDelta + degP + finalDelta;

            const fuelT = (finalIdx === 1) ? 0 : (fuelU * refuelRate);
            const pitFinal = (finalIdx === 1)
              ? 0
              : (basePit + fuelT + (tyreChangeFinal ? tyreChangeTime : 0));

            const startE = (finalIdx === 1) ? firstLapPenalty : 0;
            const outF = (finalIdx === 1)
              ? 0
              : (outLapLoss + (tyreChangeFinal ? warmupLoss : 0));

            const inF = inLapLoss;

            const driveF = L * lapT;
            const blockF = pitFinal + startE + outF + driveF + inF;

            const candidate = { L, lapT, fuelU, pitFinal, outF, driveF, blockF, fuelPerLap: fuelPerLapX };
            lastLegal = candidate;

            if (blockF >= Math.max(remaining, 0)) {
              solution = candidate;
              break;
            }
          }

          return { solution, lastLegal };
        };

        let chosen = null;
        const { solution: baseSolution, lastLegal: baseLastLegal } = searchWithFuelPerLap(finalFuelProf.fuelTarget);

        if (baseSolution) {
          chosen = baseSolution;
        } else if (finalStintMode === "save") {
          const maxRed = Math.max(0, Math.min(50, maxSavePercent || 0));
          let saveSolution = null;
          let bestLastLegal = baseLastLegal;

          for (let red = 1; red <= maxRed; red++) {
            const factor = 1 - red / 100;
            const fuelLap = finalFuelProf.fuelTarget * factor;
            const { solution, lastLegal } = searchWithFuelPerLap(fuelLap);

            if (lastLegal) bestLastLegal = lastLegal;

            if (solution) {
              saveSolution = solution;
              warning = `Final stint uses Super Save: fuel target reduced from ${finalFuelProf.fuelTarget.toFixed(2)} to ${fuelLap.toFixed(2)} ${unitPerLapLabel} to stay within tank capacity.`;
              break;
            }
          }

          if (saveSolution) {
            chosen = saveSolution;
          } else if (bestLastLegal) {
            const missing = Math.max(0, remaining - bestLastLegal.blockF);
            const extended = { ...bestLastLegal };
            extended.pitFinal += missing;
            extended.blockF   += missing;
            chosen = extended;
            warning = `Final stint cannot fully cover race duration within tank capacity (even with Super Save). Pit time extended by ${(missing/60).toFixed(1)} min.`;
          }
        } else {
          if (baseLastLegal) {
            const missing = Math.max(0, remaining - baseLastLegal.blockF);
            const extended = { ...baseLastLegal };
            extended.pitFinal += missing;
            extended.blockF   += missing;
            chosen = extended;
            warning = `Final stint cannot fully cover race duration within tank capacity. Pit time extended by ${(missing/60).toFixed(1)} min.`;
          }
        }

        if (chosen && chosen.L > 0) {
          rows.push({
            stintIndex: finalIdx,
            label: `Last (${finalIdx})`,
            fuelSource: finalFuelProf.src,
            fuelTarget: chosen.fuelPerLap,
            fuelUsed: chosen.fuelU,
            laps: chosen.L,
            lapTimeTarget: chosen.lapT,
            pitTime: chosen.pitFinal,
            tyreChange: tyreChangeFinal ? "Yes" : "No",
            tyreSet: finalTyreSet,
            compound: finalCompound,
            blockSeconds: chosen.blockF,
            driveSeconds: chosen.driveF,
            outPenaltySeconds: chosen.outF
          });
        } else if (rows.length > 0) {
          rows[rows.length - 1].label = `Last (${rows[rows.length - 1].stintIndex})`;
        }

        return { rows, warning };
      };

      /* ------------------------------------------------------------
         STATS FOR COMPARISON (A/B/C)
      -------------------------------------------------------------*/
      const getPlanStats = (code) => {
        const { rows } = buildPlanOutline(code);
        if (!rows.length) {
          return {
            totalLaps: 0, totalFuel: 0, avgFuelLap: 0,
            totalStints: 0, totalDriveSec: 0, totalPitSec: 0, totalTimeSec: 0
          };
        }
        const totalLaps = rows.reduce((s,r)=>s+r.laps,0);
        const totalFuel = rows.reduce((s,r)=>s+r.fuelUsed,0);
        const totalTimeSec = rows.reduce((s,r)=>s+(r.blockSeconds||0),0);
        const totalDriveSec = rows.reduce((s,r)=>s+(r.driveSeconds||0),0);
        const totalPitSec = totalTimeSec - totalDriveSec;
        const avgFuelLap = totalLaps ? totalFuel/totalLaps : 0;

        return {
          totalLaps, totalFuel, avgFuelLap,
          totalStints: rows.length,
          totalDriveSec, totalPitSec, totalTimeSec
        };
      };

      const statsA = getPlanStats("A");
      const statsB = getPlanStats("B");
      const statsC = getPlanStats("C");

      /* ------------------------------------------------------------
         TIMED ROWS
      -------------------------------------------------------------*/
      const { rows: outlineRows, warning: currentPlanWarning } = buildPlanOutline(plan);

      let gameMinForRows = timeToMin(gameStart);
      let utcMinForRows  = timeToMin(utcStart);
      const timedRows = outlineRows.map((r) => {
        const startGame = gameMinForRows;
        const startUtc  = utcMinForRows;
        const blockMin  = (r.blockSeconds || 0) / 60;
        gameMinForRows += blockMin;
        utcMinForRows  += blockMin;
        return {
          ...r,
          _gameStart: minToTime(Math.round(startGame)),
          _utcStart:  minToTime(Math.round(startUtc))
        };
      });

      /* ------------------------------------------------------------
         GOOGLE SHEETS COLOR SCRIPT (UPDATED FOR NEW CSV COLUMNS)
         Columns:
          A Stint #
          B Lap Time Target
          C Fuel Target
          D Fuel Used
          E Pit Time (s)
          F Tyre Change
          G Tyre Compound
          H Tyre Set #
          I Laps
          J Stint Length (min)
          K Fuel Source (PUSH/NORMAL/SAVE)
          L Driver
          M Game Start
          N UTC Start
          O Driver A
          P Driver B
          Q Driver C
          R Driver D
          S Available
          T Maybe
          U Unavailable
      -------------------------------------------------------------*/
      const googleSheetsColorScript = `
function applyRaceplanColors() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const values = sheet.getDataRange().getValues();

  const TYRECHANGE_COL  = 6;   // F
  const COMPOUND_COL    = 7;   // G
  const DRIVER_COL      = 12;  // L
  const GAME_COL        = 13;  // M
  const UTC_COL         = 14;  // N

  const DRIVER_A_COL    = 15;  // O
  const DRIVER_B_COL    = 16;  // P
  const DRIVER_C_COL    = 17;  // Q
  const DRIVER_D_COL    = 18;  // R

  const AVAIL_COL       = 19;  // S
  const MAYBE_COL       = 20;  // T
  const UNAVAIL_COL     = 21;  // U

  const COLORS = {
    yes:         "#00C853",
    no:          "#D50000",
    soft:        "#FF0000",
    medium:      "#FFD700",
    hard:        "#BFBFBF",
    wet:         "#0070C0",
    driverA:     "#00FF00",
    driverB:     "#FFFF00",
    driverC:     "#FF0000",
    driverD:     "#00FFFF",
    gameBand:    "#00B8D9",
    utcBand:     "#00B8D9",
    available:   "#00C853",
    maybe:       "#FFFF00",
    unavailable: "#FF0000"
  };

  sheet.getRange(1, DRIVER_A_COL).setBackground(COLORS.driverA);
  sheet.getRange(1, DRIVER_B_COL).setBackground(COLORS.driverB);
  sheet.getRange(1, DRIVER_C_COL).setBackground(COLORS.driverC);
  sheet.getRange(1, DRIVER_D_COL).setBackground(COLORS.driverD);

  for (let r = 3; r <= values.length; r++) {
    const row = values[r - 1];

    const tyreChange = String(row[TYRECHANGE_COL - 1] || "").toLowerCase();
    const compound   = String(row[COMPOUND_COL    - 1] || "").toLowerCase();
    const driver     = String(row[DRIVER_COL      - 1] || "").trim();

    if (tyreChange === "yes") sheet.getRange(r, TYRECHANGE_COL).setBackground(COLORS.yes);
    else if (tyreChange === "no") sheet.getRange(r, TYRECHANGE_COL).setBackground(COLORS.no);

    if (compound.includes("soft")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.soft);
    else if (compound.includes("medium")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.medium);
    else if (compound.includes("hard")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.hard);
    else if (compound.includes("wet")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.wet);

    const nameA = String(values[0][DRIVER_A_COL - 1] || "").trim();
    const nameB = String(values[0][DRIVER_B_COL - 1] || "").trim();
    const nameC = String(values[0][DRIVER_C_COL - 1] || "").trim();
    const nameD = String(values[0][DRIVER_D_COL - 1] || "").trim();

    if (driver && driver === nameA) sheet.getRange(r, DRIVER_A_COL).setBackground(COLORS.driverA);
    if (driver && driver === nameB) sheet.getRange(r, DRIVER_B_COL).setBackground(COLORS.driverB);
    if (driver && driver === nameC) sheet.getRange(r, DRIVER_C_COL).setBackground(COLORS.driverC);
    if (driver && driver === nameD) sheet.getRange(r, DRIVER_D_COL).setBackground(COLORS.driverD);

    if (row[GAME_COL - 1]) sheet.getRange(r, GAME_COL).setBackground(COLORS.gameBand);
    if (row[UTC_COL - 1]) sheet.getRange(r, UTC_COL).setBackground(COLORS.utcBand);
  }

  for (let r = 1; r <= values.length; r++) {
    const row = values[r - 1];
    const a = String(row[AVAIL_COL  - 1] || "").toLowerCase();
    const m = String(row[MAYBE_COL  - 1] || "").toLowerCase();
    const u = String(row[UNAVAIL_COL- 1] || "").toLowerCase();

    if (a === "available" || a === "a") sheet.getRange(r, AVAIL_COL).setBackground(COLORS.available);
    if (m === "maybe" || m === "m") sheet.getRange(r, MAYBE_COL).setBackground(COLORS.maybe);
    if (u === "unavailable" || u === "u") sheet.getRange(r, UNAVAIL_COL).setBackground(COLORS.unavailable);
  }
}
      `.trim();

      const copyColorScriptToClipboard = () => {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(googleSheetsColorScript)
            .then(() => alert("Apps Script copied! Paste into Extensions → Apps Script in your Sheet."))
            .catch(() => alert("Clipboard blocked. Please copy manually."));
        } else {
          alert("Clipboard not available. Please copy manually.");
        }
      };

      /* ------------------------------------------------------------
         CSV EXPORT (UPDATED)
      -------------------------------------------------------------*/
      const exportCSV = () => {
        if (!timedRows.length) {
          alert("Nothing to export — no stints generated.");
          return;
        }

        const fuelTargetHeader = (fuelUnit === "VE")
          ? "Fuel Target (%/lap)"
          : "Fuel Target (L/lap)";

        const fuelUsedHeader = (fuelUnit === "VE")
          ? "Fuel Used (%VE)"
          : "Fuel Used (L)";

        let csv = [
          "Stint #",
          "Lap Time Target",
          fuelTargetHeader,
          fuelUsedHeader,
          "Pit Time (s)",
          "Tyre Change",
          "Tyre Compound",
          "Tyre Set #",
          "Laps",
          "Stint Length (min)",
          "Fuel Source",
          "Driver",
          "Game Start Time",
          "UTC Start Time",
          "Driver A",
          "Driver B",
          "Driver C",
          "Driver D",
          "Available",
          "Maybe",
          "Unavailable"
        ].join(";") + "\n";

        csv += "Quali;;;;;;;;;;;;;;;;;;;;\n";

        timedRows.forEach((r) => {
          const k = keyOf(plan, r.stintIndex);
          const driver = (driverNames[k] || "").replace(/;/g, ",");

          const lapTimeTxt = "'" + formatLap(r.lapTimeTarget);

          const tgtTxt = r.fuelTarget.toFixed(2).replace(".", ",");
          const usedTxt = r.fuelUsed.toFixed(2).replace(".", ",");

          const pitTxt = r.pitTime.toFixed(2).replace(".", ",");
          const stintMin = ((r.driveSeconds + r.outPenaltySeconds) / 60).toFixed(1).replace(".", ",");

          const fuelSrcName = MODE[r.fuelSource].name;

          const line = [
            r.label,
            lapTimeTxt,
            tgtTxt,
            usedTxt,
            pitTxt,
            r.tyreChange,
            r.compound,
            r.tyreSet,
            r.laps,
            stintMin,
            fuelSrcName,
            driver,
            r._gameStart,
            r._utcStart,
            "", "", "", "",
            "", "", ""
          ].join(";");

          csv += line + "\n";
        });

        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Raceplan_${MODE[plan].name}_${fuelUnit === "VE" ? "VE" : "Liters"}_GoogleSheets.csv`;
        link.click();
      };

      const planChip = (p) => {
        if (p === "A") return { cls: "btn-lime", label: "Plan A (PUSH)" };
        if (p === "B") return { cls: "btn-mag",  label: "Plan B (NORMAL)" };
        return { cls: "btn-cyan", label: "Plan C (SAVE)" };
      };

      /* ------------------------------------------------------------
         UI
      -------------------------------------------------------------*/
      return (
        <div className="p-4 flex flex-col lg:flex-row gap-5">
          {/* LEFT CONTROL PANEL */}
          <div className="w-full lg:w-1/3 space-y-4">

            {/* BASE SETTINGS */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">
                  Base Settings
                  <span className="hud-chip">Fuel + Pace</span>
                </div>
                <span className="tag">
                  <span className="dot" style={{background:`var(${MODE[plan].colorVar})`}}></span>
                  {MODE[plan].name}
                </span>
              </div>

              <div className="hud-body space-y-3">
                {/* Fuel unit switch */}
                <div>
                  <div className="hud-label mb-2">Fuel Unit</div>
                  <div className="seg">
                    <button
                      className={fuelUnit === "VE" ? "active" : ""}
                      onClick={()=>switchUnit("VE")}
                      title="Use VE% everywhere (fuel target, buffer, refuel rate, export)"
                    >
                      VE
                    </button>
                    <button
                      className={fuelUnit === "L" ? "active" : ""}
                      onClick={()=>switchUnit("L")}
                      title="Use liters everywhere (fuel target, buffer, refuel rate, export)"
                    >
                      L
                    </button>
                  </div>
                  <div className="hud-help mt-1">
                    Switch converts <b>fuel usage</b>, <b>buffer</b> and <b>refuel rate</b> to keep the same real-world meaning.
                  </div>
                </div>

                <div className="hud-grid cols2">
                  <div>
                    <div className="hud-label">Lap Time (m:ss.sss)</div>
                    <input value={lapTimeStr} onChange={handleLapTimeChange} className="hud-input w-full"/>
                    <div className="hud-help mt-1">{lapTimeSec.toFixed(3)} s</div>
                  </div>
                  <div>
                    <div className="hud-label">Race Duration (H:MM:SS)</div>
                    <input value={raceDurationStr} onChange={handleRaceTimeChange} className="hud-input w-full"/>
                    <div className="hud-help mt-1">{(raceDurationSec/3600).toFixed(2)} h</div>
                  </div>
                </div>

                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">Tank Capacity (L)</div>
                    <input
                      type="number" step="0.1"
                      value={tankLiters}
                      onChange={(e)=>setTankLiters(Math.max(0, parseFloat(e.target.value)||0))}
                      className="hud-input w-full"
                    />
                    <div className="hud-help mt-1">Mapping: 100% VE = {tankLiters.toFixed(1)} L</div>
                  </div>

                  <div>
                    <div className="hud-label">Base Use per Lap ({unitPerLapLabel})</div>
                    <input
                      type="number" step="0.01"
                      value={baseUsePerLap}
                      onChange={(e)=>setBaseUsePerLap(parseFloat(e.target.value)||0)}
                      className="hud-input w-full"
                    />
                    <div className="hud-help mt-1">Used to compute PUSH/NORMAL/SAVE targets.</div>
                  </div>

                  <div>
                    <div className="hud-label">Safety Buffer ({unitLabel})</div>
                    <input
                      type="number" step="0.01"
                      value={fuelBuffer}
                      onChange={(e)=>setFuelBuffer(parseFloat(e.target.value)||0)}
                      className="hud-input w-full"
                    />
                  </div>
                </div>

                <div>
                  <div className="hud-label">Tyre Deg (s/lap/lap)</div>
                  <input
                    type="number" step="0.001"
                    value={tyreDeg}
                    onChange={(e)=>setTyreDeg(parseFloat(e.target.value)||0)}
                    className="hud-input w-full"
                  />
                </div>

                <div className="hud-card" style={{background:"rgba(0,0,0,0.22)", boxShadow:"none", borderRadius:"14px"}}>
                  <div className="hud-body">
                    <div className="hud-title" style={{fontSize:"10px", marginBottom:"8px"}}>
                      Mode Pace Deltas (s/lap)
                    </div>
                    <div className="hud-grid cols2">
                      <div>
                        <div className="hud-label">NORMAL Delta</div>
                        <input
                          type="number" step="0.05"
                          value={paceDeltaB}
                          onChange={(e)=>setPaceDeltaB(parseFloat(e.target.value)||0)}
                          className="hud-input w-full"
                        />
                        <div className="hud-help mt-1">Applied when fuel source is NORMAL.</div>
                      </div>
                      <div>
                        <div className="hud-label">SAVE Delta</div>
                        <input
                          type="number" step="0.05"
                          value={paceDeltaC}
                          onChange={(e)=>setPaceDeltaC(parseFloat(e.target.value)||0)}
                          className="hud-input w-full"
                        />
                        <div className="hud-help mt-1">Applied when fuel source is SAVE.</div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {/* COMPOUND DELTAS */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Tyre Compound Deltas</div>
                <span className="tag"><span className="dot" style={{background:"var(--mag)"}}></span>s/lap</span>
              </div>
              <div className="hud-body space-y-2">
                {["Soft","Medium","Hard","Wet"].map((c)=>(
                  <div key={c} className="flex items-center gap-2">
                    <div className="hud-label w-20">{c}</div>
                    <input
                      type="number" step="0.05"
                      value={compoundDeltas[c]}
                      onChange={(e)=>setCompoundDeltas({ ...compoundDeltas, [c]: parseFloat(e.target.value)||0 })}
                      className="hud-input flex-1"
                    />
                  </div>
                ))}
                <div className="hud-help mt-2">
                  If <b>No tyre change</b>, the next stint automatically carries over the previous compound.
                </div>
              </div>
            </div>

            {/* PIT & TIME LOSSES */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Pit & Time Loss</div>
                <span className="tag"><span className="dot" style={{background:"var(--cyan)"}}></span>seconds</span>
              </div>
              <div className="hud-body space-y-3">
                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">Base Pit (s)</div>
                    <input type="number" value={basePit} onChange={(e)=>setBasePit(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Tyre Change (s)</div>
                    <input type="number" value={tyreChangeTime} onChange={(e)=>setTyreChangeTime(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Refuel Rate ({refuelLabel})</div>
                    <input type="number" step="0.01" value={refuelRate} onChange={(e)=>setRefuelRate(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                </div>

                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">In-lap Loss</div>
                    <input type="number" value={inLapLoss} onChange={(e)=>setInLapLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Out-lap Loss</div>
                    <input type="number" value={outLapLoss} onChange={(e)=>setOutLapLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Warmup (tyres)</div>
                    <input type="number" value={warmupLoss} onChange={(e)=>setWarmupLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                </div>

                <div>
                  <div className="hud-label">First Lap Penalty (s)</div>
                  <input type="number" value={firstLapPenalty} onChange={(e)=>setFirstLapPenalty(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                </div>
              </div>
            </div>

            {/* START TIMES */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Session Start Times</div>
                <span className="tag"><span className="dot" style={{background:"var(--lime)"}}></span>clock</span>
              </div>
              <div className="hud-body space-y-3">
                <div>
                  <div className="hud-label">Game Start Time</div>
                  <input type="time" value={gameStart} onChange={(e)=>setGameStart(e.target.value)} className="hud-input w-full" />
                </div>
                <div>
                  <div className="hud-label">EST Start Time UTC</div>
                  <input type="time" value={utcStart} onChange={(e)=>setUtcStart(e.target.value)} className="hud-input w-full" />
                  <div className="hud-help mt-1">EST = Estimated Start (UTC). Adjust for official timetable.</div>
                </div>
              </div>
            </div>

          </div>

          {/* RIGHT MAIN PANEL */}
          <div className="w-full lg:w-2/3 space-y-4">

            {/* COMPARISON SUMMARY */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Mode Comparison Summary</div>
                <span className="hud-chip">Push / Normal / Save</span>
              </div>
              <div className="hud-body">
                <div className="overflow-x-auto">
                  <table className="hud-table">
                    <thead>
                      <tr>
                        <th className="hud-th">Metric</th>
                        <th className="hud-th" style={{color:"rgba(124,255,91,0.9)"}}>PUSH</th>
                        <th className="hud-th" style={{color:"rgba(255,56,209,0.9)"}}>NORMAL</th>
                        <th className="hud-th" style={{color:"rgba(54,215,255,0.9)"}}>SAVE</th>
                      </tr>
                    </thead>
                    <tbody>
                      {[
                        ["Total race laps", statsA.totalLaps, statsB.totalLaps, statsC.totalLaps],
                        [`Avg fuel / lap (${unitPerLapLabel})`, statsA.avgFuelLap.toFixed(3), statsB.avgFuelLap.toFixed(3), statsC.avgFuelLap.toFixed(3)],
                        ["Total stints", statsA.totalStints, statsB.totalStints, statsC.totalStints],
                        ["Drive time (min)", (statsA.totalDriveSec/60).toFixed(1), (statsB.totalDriveSec/60).toFixed(1), (statsC.totalDriveSec/60).toFixed(1)],
                        ["Pit time (min)", (statsA.totalPitSec/60).toFixed(1), (statsB.totalPitSec/60).toFixed(1), (statsC.totalPitSec/60).toFixed(1)],
                        ["Total time (min)", (statsA.totalTimeSec/60).toFixed(1), (statsB.totalTimeSec/60).toFixed(1), (statsC.totalTimeSec/60).toFixed(1)],
                      ].map((row, i)=>(
                        <tr key={i}>
                          <td className="hud-td">{row[0]}</td>
                          <td className="hud-td">{row[1]}</td>
                          <td className="hud-td">{row[2]}</td>
                          <td className="hud-td">{row[3]}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="hud-help mt-2">
                  Includes per-stint fuel source overrides + compound carry-over. Final stint solver is applied per plan.
                </div>
              </div>
            </div>

            {/* FINAL STINT STRATEGY */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Final Stint Strategy</div>
                <span className="tag"><span className="dot" style={{background:"var(--amber)"}}></span>last stint</span>
              </div>
              <div className="hud-body space-y-3">
                <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                  <div className="space-y-2 text-sm">
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        className="accent-[var(--lime)]"
                        checked={finalStintMode === "pit"}
                        onChange={()=>setFinalStintMode("pit")}
                      />
                      <span>Auto extend pit time if last stint can't finish within tank capacity.</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        className="accent-[var(--lime)]"
                        checked={finalStintMode === "save"}
                        onChange={()=>setFinalStintMode("save")}
                      />
                      <span>Try Super-Save fuel target first, then extend pit if still needed.</span>
                    </label>
                  </div>
                  <div className="text-sm">
                    <div className="hud-label mb-1">Max Super-Save Reduction (%)</div>
                    <input
                      type="number"
                      min={0}
                      max={50}
                      value={maxSavePercent}
                      disabled={finalStintMode !== "save"}
                      onChange={(e)=>{
                        const v = parseFloat(e.target.value);
                        const clamped = Math.max(0, Math.min(50, isNaN(v)?0:v));
                        setMaxSavePercent(clamped);
                      }}
                      className="hud-input w-24"
                    />
                    <div className="hud-help mt-1">Only affects the last stint in Super-Save mode.</div>
                  </div>
                </div>
              </div>
            </div>

            {/* PLAN MENU (like original) */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Plan</div>
                <span className="hud-chip">Select + Export</span>
              </div>
              <div className="hud-body flex flex-wrap items-center gap-2">
                {["A","B","C"].map((p)=>{
                  const meta = planChip(p);
                  return (
                    <button
                      key={p}
                      onClick={()=>setPlan(p)}
                      className={`hud-btn ${meta.cls} ${plan===p ? "active" : ""}`}
                      title={meta.label}
                    >
                      {p}
                    </button>
                  );
                })}

                <div className="ml-auto flex items-center gap-2">
                  <button onClick={exportCSV} className="hud-btn btn-cyan">
                    Export CSV
                  </button>
                </div>
              </div>
              <div className="hud-body" style={{paddingTop:0}}>
                <div className="hud-help">
                  A = <b>PUSH</b>, B = <b>NORMAL</b>, C = <b>SAVE</b>. Per-stint fuel source can override the plan.
                </div>
              </div>
            </div>

            {/* OUTLINE TABLE */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Stint Outline</div>
                <span className="tag">
                  <span className="dot" style={{background:`var(${MODE[plan].colorVar})`}}></span>
                  {MODE[plan].name}
                </span>
              </div>
              <div className="hud-body">
                <div className="overflow-x-auto">
                  <table className="hud-table">
                    <thead>
                      <tr>
                        <th className="hud-th">Stint</th>
                        <th className="hud-th">Lap Target</th>
                        <th className="hud-th">Fuel Tgt</th>
                        <th className="hud-th">Fuel Used</th>
                        <th className="hud-th">Pit</th>
                        <th className="hud-th">Tyre</th>
                        <th className="hud-th">Compound</th>
                        <th className="hud-th">Set</th>
                        <th className="hud-th">Laps</th>
                        <th className="hud-th">Len (min)</th>
                        <th className="hud-th">Fuel Source</th>
                        <th className="hud-th">Driver</th>
                        <th className="hud-th">Game</th>
                        <th className="hud-th">UTC</th>
                      </tr>
                    </thead>

                    <tbody>
                      {timedRows.map((r)=>{
                        const k = keyOf(plan, r.stintIndex);
                        const stintMins = ((r.driveSeconds + r.outPenaltySeconds)/60).toFixed(1);

                        const tyreChangeLabel = r.tyreChange;
                        const isNoChange = r.stintIndex !== 1 && tyreChangeLabel === "No";

                        const compoundValue = r.compound; // already includes carry-over logic

                        const fuelSrcValue = getFuelSource(plan, r.stintIndex);

                        return (
                          <tr key={k}>
                            <td className="hud-td">{r.label}</td>
                            <td className="hud-td">{formatLap(r.lapTimeTarget)}</td>
                            <td className="hud-td">{r.fuelTarget.toFixed(2)} <span style={{opacity:.7}}>{unitPerLapLabel}</span></td>
                            <td className="hud-td">{r.fuelUsed.toFixed(2)} <span style={{opacity:.7}}>{unitLabel}</span></td>
                            <td className="hud-td">{r.pitTime.toFixed(2)}</td>

                            <td className="hud-td">
                              <button
                                onClick={()=>toggleTyreChange(plan, r.stintIndex, r.tyreChange)}
                                className={"hud-btn " + (r.tyreChange==="Yes" ? "btn-lime" : "btn-mag")}
                                style={{padding:"6px 10px", fontSize:"10px"}}
                                title={r.tyreChange==="Yes" ? "Tyre change on this stop" : "No tyre change (compound carries over)"}
                              >
                                {r.tyreChange}
                              </button>
                            </td>

                            <td className="hud-td">
                              <select
                                value={compoundValue}
                                disabled={isNoChange}
                                onChange={(e)=>setStintCompound(plan, r.stintIndex, e.target.value)}
                                className={"hud-select w-full " + compoundClass(compoundValue) + (isNoChange ? " opacity-60 cursor-not-allowed" : "")}
                                title={isNoChange ? "No tyre change → compound locked to previous stint" : "Select compound for this tyre set"}
                              >
                                <option value="Soft">Soft</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                                <option value="Wet">Wet</option>
                              </select>
                            </td>

                            <td className="hud-td">{r.tyreSet}</td>
                            <td className="hud-td">{r.laps}</td>
                            <td className="hud-td">{stintMins}</td>

                            {/* Fuel override dropdown (Push/Normal/Save) */}
                            <td className="hud-td">
                              <select
                                value={fuelSrcValue}
                                onChange={(e)=>setFuelSource(plan, r.stintIndex, e.target.value)}
                                className="hud-select w-44"
                                title="Select fuel profile for this stint (also applies the linked lap-time delta)"
                              >
                                <option value="A">{fuelOptionLabel("A")}</option>
                                <option value="B">{fuelOptionLabel("B")}</option>
                                <option value="C">{fuelOptionLabel("C")}</option>
                              </select>
                            </td>

                            <td className="hud-td">
                              <input
                                type="text"
                                value={driverNames[k] || ""}
                                onChange={(e)=>setStintDriver(plan, r.stintIndex, e.target.value)}
                                className="hud-input w-28"
                                placeholder="Name"
                              />
                            </td>

                            <td className="hud-td">{r._gameStart}</td>
                            <td className="hud-td">{r._utcStart}</td>
                          </tr>
                        );
                      })}

                      {!timedRows.length && (
                        <tr>
                          <td colSpan={14} className="hud-td" style={{textAlign:"center", color:"rgba(180,200,220,0.6)"}}>
                            Enter fuel, lap time and race duration to generate outline.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>

                {currentPlanWarning && (
                  <div className="warn mt-3">⚠ {currentPlanWarning}</div>
                )}
              </div>
            </div>

            {/* GOOGLE SHEETS COLOR HELP */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Google Sheets Coloring</div>
                <button
                  onClick={()=>setShowGsHelp(v=>!v)}
                  className="hud-btn btn-mag"
                  style={{padding:"7px 10px"}}
                >
                  {showGsHelp ? "Hide" : "Show"}
                </button>
              </div>

              <div className="hud-body">
                <div className="hud-help" style={{fontSize:"12px"}}>
                  Auto-color tyre changes, compounds, drivers & availability (script matches the updated CSV columns)
                </div>

                {showGsHelp && (
                  <div className="mt-3 space-y-3">
                    <ol className="list-decimal list-inside space-y-1" style={{color:"rgba(235,245,255,0.86)"}}>
                      <li>Click <b>Export CSV</b>.</li>
                      <li>Import CSV into a new Google Sheet (separator = <b>semicolon</b>).</li>
                      <li>Go to <b>Extensions → Apps Script</b>.</li>
                      <li>Delete everything and paste the script below.</li>
                      <li>In row 1, columns O–R, type your Driver A–D names.</li>
                      <li>Run <code>applyRaceplanColors()</code>.</li>
                    </ol>

                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="hud-label">Apps Script</span>
                        <button
                          onClick={copyColorScriptToClipboard}
                          className="hud-btn btn-lime"
                          style={{padding:"7px 10px"}}
                        >
                          Copy Script
                        </button>
                      </div>
                      <textarea
                        readOnly
                        className="hud-input w-full"
                        style={{height:"200px", fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace", fontSize:"11px"}}
                        value={googleSheetsColorScript}
                      />
                    </div>
                  </div>
                )}
              </div>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<RacePlanner />);
  </script>
</body>
</html>
