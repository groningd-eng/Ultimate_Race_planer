<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ultimate Race Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind (layout utility only; main "HUD" look is custom CSS below) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts (HUD-ish) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --bg: #05070c;
      --panel: rgba(12, 16, 26, 0.92);
      --panel2: rgba(9, 12, 20, 0.92);
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.16);
      --txt: rgba(235, 245, 255, 0.92);
      --muted: rgba(180, 200, 220, 0.62);

      --lime: #7CFF5B;
      --mag: #FF38D1;
      --cyan: #36D7FF;
      --amber: #FFC857;
      --red: #FF3B3B;

      --shadow: 0 12px 40px rgba(0,0,0,0.65);
      --glowL: 0 0 18px rgba(124,255,91,0.22);
      --glowM: 0 0 18px rgba(255,56,209,0.22);
      --glowC: 0 0 18px rgba(54,215,255,0.22);
    }

    body{
      margin: 0;
      background: radial-gradient(1200px 700px at 30% -10%, rgba(54,215,255,0.16), transparent 55%),
                  radial-gradient(1100px 700px at 85% 10%, rgba(255,56,209,0.10), transparent 55%),
                  radial-gradient(1000px 700px at 50% 100%, rgba(124,255,91,0.08), transparent 55%),
                  var(--bg);
      color: var(--txt);
      font-family: Rajdhani, system-ui, -apple-system, Segoe UI, sans-serif;
      letter-spacing: 0.2px;
    }

    /* HUD cards */
    .hud-card{
      background: linear-gradient(180deg, rgba(16,20,34,0.92), rgba(9,12,20,0.92));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
    }
    .hud-card::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(90deg,
        rgba(54,215,255,0.10),
        rgba(255,56,209,0.08),
        rgba(124,255,91,0.08)
      );
      opacity: 0.25;
      mix-blend-mode: screen;
    }

    .hud-head{
      position: relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.12));
    }
    .hud-title{
      font-family: Orbitron, Rajdhani, sans-serif;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 11px;
      color: rgba(235,245,255,0.78);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .hud-chip{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border2);
      background: rgba(0,0,0,0.35);
      color: rgba(235,245,255,0.82);
    }

    .hud-body{ position: relative; padding: 12px; }

    .hud-label{ font-size: 12px; color: var(--muted); }
    .hud-help{ font-size: 11px; color: rgba(180,200,220,0.55); }

    .hud-input, .hud-select, .hud-btn{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: rgba(235,245,255,0.92);
      padding: 8px 10px;
      outline: none;
      transition: 120ms ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    .hud-input:focus, .hud-select:focus{
      border-color: rgba(54,215,255,0.45);
      box-shadow: 0 0 0 3px rgba(54,215,255,0.18), inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .hud-select option{
      background: #0b0f1a;
      color: rgba(235,245,255,0.92);
    }
    .hud-input[disabled], .hud-select[disabled]{
      opacity: 0.55;
      cursor: not-allowed;
    }

    .hud-btn{
      font-family: Orbitron, sans-serif;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      padding: 9px 12px;
    }
    .btn-lime{ border-color: rgba(124,255,91,0.45); box-shadow: var(--glowL); }
    .btn-mag { border-color: rgba(255,56,209,0.45); box-shadow: var(--glowM); }
    .btn-cyan{ border-color: rgba(54,215,255,0.45); box-shadow: var(--glowC); }
    .btn-lime.active{ background: rgba(124,255,91,0.14); }
    .btn-mag.active { background: rgba(255,56,209,0.14); }
    .btn-cyan.active{ background: rgba(54,215,255,0.14); }

    .hud-grid{ display:grid; gap: 10px; }
    .hud-grid.cols2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .hud-grid.cols3{ grid-template-columns: repeat(3, minmax(0, 1fr)); }

    .hud-table{
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      font-size: 12px;
    }
    .hud-th{
      font-family: Orbitron, sans-serif;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(180,200,220,0.65);
      padding: 6px 10px;
      text-align: left;
      white-space: nowrap;
    }
    .hud-row{
      background: rgba(0,0,0,0.34);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .hud-td{
      padding: 8px 10px;
      border-top: 1px solid rgba(255,255,255,0.08);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      white-space: nowrap;
    }
    .hud-td:first-child{
      border-left: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px 0 0 12px;
    }
    .hud-td:last-child{
      border-right: 1px solid rgba(255,255,255,0.08);
      border-radius: 0 12px 12px 0;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      font-size: 11px;
      background: rgba(0,0,0,0.25);
      color: rgba(235,245,255,0.86);
    }
    .dot{ width: 8px; height: 8px; border-radius: 999px; display:inline-block; }

    /* Compound "chips" (table select keeps your color logic but slightly HUD-ified) */
    .cmp-soft{ background: rgba(255,59,59,0.20) !important; border-color: rgba(255,59,59,0.45) !important; }
    .cmp-med { background: rgba(255,200,87,0.18) !important; border-color: rgba(255,200,87,0.45) !important; }
    .cmp-hard{ background: rgba(200,210,220,0.14) !important; border-color: rgba(200,210,220,0.35) !important; }
    .cmp-wet { background: rgba(54,215,255,0.16) !important; border-color: rgba(54,215,255,0.45) !important; }

    .warn{
      border: 1px solid rgba(255,200,87,0.35);
      background: rgba(255,200,87,0.10);
      border-radius: 12px;
      padding: 10px 12px;
      color: rgba(255,230,170,0.95);
    }

    @media (max-width: 1024px){
      .hud-grid.cols3{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    function RacePlanner() {
      /* ------------------------------------------------------------
         STATE / DEFAULTS
      -------------------------------------------------------------*/

      // Fuel & VE
      const [veTotal] = useState(100);          // locked at 100
      const [vePerLap, setVePerLap] = useState(4.5);
      const [safetyBuffer, setSafetyBuffer] = useState(0.2);

      // Lap time
      const [lapTimeStr, setLapTimeStr] = useState("4:00.000");
      const [lapTimeSec, setLapTimeSec] = useState(240);

      // Race duration (24h)
      const [raceDurationStr, setRaceDurationStr] = useState("24:00:00");
      const [raceDurationSec, setRaceDurationSec] = useState(86400);

      // Pits
      const [basePit, setBasePit] = useState(25);
      const [tyreChangeTime, setTyreChangeTime] = useState(13);
      const [fuelRate, setFuelRate] = useState(0.4);     // 0.4 s / %VE

      const [inLapLoss, setInLapLoss] = useState(1.5);
      const [outLapLoss, setOutLapLoss] = useState(2.0);
      const [warmupLoss, setWarmupLoss] = useState(3.0);

      // Start penalties
      const [startLoss] = useState(0);                  // removed from UI
      const [firstLapPenalty, setFirstLapPenalty] = useState(5.0);

      // Tyre deg
      const [tyreDeg, setTyreDeg] = useState(0.02);

      // ✅ Delta adjustability for Plan B / C (pace penalty s/lap)
      const [pacePenaltyB, setPacePenaltyB] = useState(0.5);
      const [pacePenaltyC, setPacePenaltyC] = useState(1.0);

      // Compound deltas
      const [compoundDeltas, setCompoundDeltas] = useState({
        Soft: -0.5,
        Medium: 0.0,
        Hard: 0.5,
        Wet: 10.0
      });

      // Start times
      const [gameStart, setGameStart] = useState("12:00");
      const [utcStart,  setUtcStart]  = useState("14:00");

      // Active plan (A/B/C)
      const [plan, setPlan] = useState("A");

      // Per-stint overrides
      const [tyreChanges, setTyreChanges] = useState({});
      const [stintCompounds, setStintCompounds] = useState({});
      const [driverNames, setDriverNames] = useState({});

      // Google Sheets help
      const [showGsHelp, setShowGsHelp] = useState(false);

      // Final stint strategy
      const [finalStintMode, setFinalStintMode] = useState("pit");
      const [maxSavePercent, setMaxSavePercent] = useState(2);

      /* ------------------------------------------------------------
         BASIC TIME HELPERS
      -------------------------------------------------------------*/

      const parseTime = (val) => {
        if (!val) return 0;
        const p = val.split(":").map(Number);
        if (p.length === 3) return p[0]*3600 + p[1]*60 + p[2];
        if (p.length === 2) return p[0]*60 + p[1];
        return p[0];
      };

      const formatLap = (s) => {
        if (s <= 0) return "0:00.000";
        const m = Math.floor(s/60);
        const sec = (s % 60).toFixed(3).padStart(6,"0");
        return `${m}:${sec}`;
      };

      const timeToMin = (hhmm) => {
        const [h,m] = hhmm.split(":").map(Number);
        return h*60 + m;
      };

      const minToTime = (mins) => {
        const x = ((mins % 1440) + 1440) % 1440;
        const h = String(Math.floor(x/60)).padStart(2,"0");
        const m = String(x % 60).padStart(2,"0");
        return `${h}:${m}`;
      };

      /* ------------------------------------------------------------
         INPUT HANDLERS
      -------------------------------------------------------------*/

      const handleLapTimeChange = (e) => {
        const v = e.target.value;
        setLapTimeStr(v);
        const s = parseTime(v);
        if (!Number.isNaN(s)) setLapTimeSec(s);
      };

      const handleRaceTimeChange = (e) => {
        const v = e.target.value;
        setRaceDurationStr(v);
        const s = parseTime(v);
        if (!Number.isNaN(s)) setRaceDurationSec(s);
      };

      /* ------------------------------------------------------------
         PLAN DERIVATION (A / B / C)
      -------------------------------------------------------------*/

      const baseLapTime = lapTimeSec;
      const usableVE   = veTotal - safetyBuffer;

      const avgDegWithAge = (laps, deg, ageStart) => {
        if (laps <= 0 || deg <= 0) return 0;
        return deg * (2 * ageStart + (laps - 1)) / 2;
      };

      // Plan A
      const planA_laps = Math.max(1, Math.floor(usableVE / vePerLap));
      const planA_ve   = usableVE / planA_laps;
      const planA_deg  = avgDegWithAge(planA_laps, tyreDeg, 0);
      const planA_lap  = baseLapTime + planA_deg;

      // Plan B
      const planB_laps = planA_laps + 1;
      const planB_ve   = usableVE / planB_laps;
      const planB_deg  = avgDegWithAge(planB_laps, tyreDeg, 0);
      const planB_lap  = baseLapTime + planB_deg + pacePenaltyB;

      // Plan C
      const planC_laps = planA_laps + 2;
      const planC_ve   = usableVE / planC_laps;
      const planC_deg  = avgDegWithAge(planC_laps, tyreDeg, 0);
      const planC_lap  = baseLapTime + planC_deg + pacePenaltyC;

      const getPlanConfig = (code) => {
        if (code === "A") return { laps: planA_laps, veTarget: planA_ve, pace: 0 };
        if (code === "B") return { laps: planB_laps, veTarget: planB_ve, pace: pacePenaltyB };
        return { laps: planC_laps, veTarget: planC_ve, pace: pacePenaltyC };
      };

      /* ------------------------------------------------------------
         PER-STINT OVERRIDES
      -------------------------------------------------------------*/

      const toggleTyreChange = (planCode, stintIndex, currentLabel) => {
        const key = `${planCode}-${stintIndex}`;
        setTyreChanges((prev) => ({
          ...prev,
          [key]: currentLabel === "Yes" ? false : true
        }));
      };

      const setStintCompound = (planCode, stintIndex, value) => {
        const key = `${planCode}-${stintIndex}`;
        setStintCompounds((prev) => ({ ...prev, [key]: value }));
      };

      const setStintDriver = (planCode, stintIndex, value) => {
        const key = `${planCode}-${stintIndex}`;
        setDriverNames((prev) => ({ ...prev, [key]: value }));
      };

      /* ------------------------------------------------------------
         COMPOUND COLOR HELPER
      -------------------------------------------------------------*/

      const compoundClass = (compound) => {
        switch (compound) {
          case "Soft":   return "cmp-soft";
          case "Medium": return "cmp-med";
          case "Hard":   return "cmp-hard";
          case "Wet":    return "cmp-wet";
          default:       return "";
        }
      };

      /* ------------------------------------------------------------
         BUILD STINT OUTLINE (ALWAYS FINISH LAST LAP)
         returns { rows, warning } and enforces VE <= 100 on final stint.
      -------------------------------------------------------------*/

      const buildPlanOutline = (planCode) => {
        const cfg = getPlanConfig(planCode);
        if (!cfg || !cfg.laps || cfg.laps <= 0) return { rows: [], warning: "" };

        const lapsStd    = cfg.laps;
        const veTarget   = cfg.veTarget;
        const paceOffset = cfg.pace;

        const rows = [];
        let usedTime  = 0;
        let stintIdx  = 1;
        let tyreSet   = 1;
        let tyreAge   = 0;
        const maxStints = 200;
        const minLap   = Math.max(1, baseLapTime);
        const MAX_TANK = 100;

        let warning = "";

        const getTyreChange = (idx) => {
          const key = `${planCode}-${idx}`;
          const override = tyreChanges[key];
          if (override !== undefined) return override;
          return idx === 1 ? false : true;
        };

        const getCompound = (idx) => {
          const key = `${planCode}-${idx}`;
          const saved = stintCompounds[key];
          if (saved) return saved;
          return "Medium";
        };

        while (stintIdx <= maxStints) {
          const tyreChange = getTyreChange(stintIdx);
          const compound   = getCompound(stintIdx);
          const compoundDelta = compoundDeltas[compound] ?? 0;

          let ageStart;
          if (stintIdx === 1) ageStart = 0;
          else ageStart = tyreChange ? 0 : tyreAge;

          const laps = lapsStd;
          const degPenalty = avgDegWithAge(laps, tyreDeg, ageStart);
          const lapTarget  = baseLapTime + paceOffset + degPenalty + compoundDelta;
          const veUsed     = laps * veTarget;

          let pit   = 0;
          let startExtra = 0;
          let outLossVal = 0;
          let inLoss  = inLapLoss;

          if (stintIdx === 1) {
            pit = 0;
            startExtra = startLoss + firstLapPenalty;
            outLossVal = 0;
          } else {
            const fuelTime = veUsed * fuelRate;
            pit = basePit + fuelTime + (tyreChange ? tyreChangeTime : 0);
            outLossVal = outLapLoss + (tyreChange ? warmupLoss : 0);
          }

          const drive = laps * lapTarget;
          const block = pit + startExtra + outLossVal + drive + inLoss;

          if (usedTime + block + minLap <= raceDurationSec) {
            if (stintIdx === 1) tyreSet = tyreChange ? 2 : 1;
            else if (tyreChange) tyreSet += 1;

            tyreAge = (stintIdx === 1 || tyreChange) ? laps : (tyreAge + laps);

            rows.push({
              stintIndex: stintIdx,
              label: `${stintIdx}`,
              laps,
              lapTimeTarget: lapTarget,
              veTarget,
              veUsed,
              pitTime: pit,
              tyreChange: tyreChange ? "Yes" : "No",
              tyreSet,
              compound,
              blockSeconds: block,
              driveSeconds: drive,
              outPenaltySeconds: outLossVal
            });

            usedTime += block;
            stintIdx += 1;
          } else {
            break;
          }
        }

        const remaining = raceDurationSec - usedTime;

        const finalIdx  = stintIdx;
        const tyreChangeFinal = getTyreChange(finalIdx);
        const finalCompound   = getCompound(finalIdx);
        const finalDelta      = compoundDeltas[finalCompound] ?? 0;

        let finalTyreSet = tyreSet;
        if (finalIdx === 1) finalTyreSet = tyreChangeFinal ? 2 : 1;
        else if (tyreChangeFinal) finalTyreSet += 1;

        let ageStartFinal;
        if (finalIdx === 1) ageStartFinal = 0;
        else ageStartFinal = tyreChangeFinal ? 0 : tyreAge;

        const maxSearch = lapsStd + 40;

        const searchWithVe = (vePerLapX) => {
          let solution = null;
          let lastLegal = null;

          for (let L = 1; L <= maxSearch; L++) {
            const veU = L * vePerLapX;
            if (veU > MAX_TANK) break;

            const degP = avgDegWithAge(L, tyreDeg, ageStartFinal);
            const lapT = baseLapTime + paceOffset + degP + finalDelta;

            const fuelT = veU * fuelRate;
            const pitFinal = basePit + fuelT + (tyreChangeFinal ? tyreChangeTime : 0);

            let startE = 0;
            let outF = 0;
            const inF = inLapLoss;

            if (finalIdx === 1) {
              startE = startLoss + firstLapPenalty;
              outF   = 0;
            } else {
              outF = outLapLoss + (tyreChangeFinal ? warmupLoss : 0);
            }

            const driveF = L * lapT;
            const blockF = pitFinal + startE + outF + driveF + inF;

            const candidate = { L, lapT, veU, pitFinal, outF, driveF, blockF, vePerLap: vePerLapX };
            lastLegal = candidate;

            if (blockF >= Math.max(remaining, 0)) {
              solution = candidate;
              break;
            }
          }

          return { solution, lastLegal };
        };

        let chosen = null;
        const { solution: baseSolution, lastLegal: baseLastLegal } = searchWithVe(veTarget);

        if (baseSolution) {
          chosen = baseSolution;
        } else if (finalStintMode === "save") {
          const maxRed = Math.max(0, Math.min(50, maxSavePercent || 0));
          let saveSolution = null;
          let bestLastLegal = baseLastLegal;

          for (let red = 1; red <= maxRed; red++) {
            const factor = 1 - red / 100;
            const veLap = veTarget * factor;
            const { solution, lastLegal } = searchWithVe(veLap);

            if (lastLegal) bestLastLegal = lastLegal;

            if (solution) {
              saveSolution = solution;
              warning = `Final stint uses Super Save: VE target reduced from ${veTarget.toFixed(2)} to ${veLap.toFixed(2)} %/lap to finish race within fuel.`;
              break;
            }
          }

          if (saveSolution) {
            chosen = saveSolution;
          } else if (bestLastLegal) {
            const missing = Math.max(0, remaining - bestLastLegal.blockF);
            const extended = { ...bestLastLegal };
            extended.pitFinal += missing;
            extended.blockF   += missing;
            chosen = extended;
            warning = `Final stint cannot fully cover race distance within 100% VE (even with Super Save). Pit time extended by ${(missing/60).toFixed(1)} min to reach full race duration.`;
          }
        } else {
          if (baseLastLegal) {
            const missing = Math.max(0, remaining - baseLastLegal.blockF);
            const extended = { ...baseLastLegal };
            extended.pitFinal += missing;
            extended.blockF   += missing;
            chosen = extended;
            warning = `Final stint cannot fully cover race distance within 100% VE. Pit time extended by ${(missing/60).toFixed(1)} min to reach full race duration.`;
          }
        }

        if (chosen && chosen.L > 0) {
          rows.push({
            stintIndex: finalIdx,
            label: `Last (${finalIdx})`,
            laps: chosen.L,
            lapTimeTarget: chosen.lapT,
            veTarget: chosen.vePerLap,
            veUsed: chosen.veU,
            pitTime: chosen.pitFinal,
            tyreChange: tyreChangeFinal ? "Yes" : "No",
            tyreSet: finalTyreSet,
            compound: finalCompound,
            blockSeconds: chosen.blockF,
            driveSeconds: chosen.driveF,
            outPenaltySeconds: chosen.outF
          });
        } else if (rows.length > 0) {
          const last = rows[rows.length - 1];
          last.label = `Last (${last.stintIndex})`;
        }

        return { rows, warning };
      };

      /* ------------------------------------------------------------
         PLAN STATS (SUMMARY PANEL)
      -------------------------------------------------------------*/

      const getPlanStats = (code) => {
        const { rows } = buildPlanOutline(code);
        if (!rows.length) {
          return {
            totalLaps: 0, totalVe: 0, avgVELap: 0, deltaVe: 0, theoreticalLeft: 0,
            totalStints: 0, totalDriveSec: 0, totalPitSec: 0, totalTimeSec: 0,
            maxStdLaps: 0, stdLapTime: baseLapTime
          };
        }

        const cfg = getPlanConfig(code);

        const totalLaps = rows.reduce((s,r)=>s+r.laps,0);
        const totalVe   = rows.reduce((s,r)=>s+r.veUsed,0);
        const totalTimeSec = rows.reduce((s,r)=>s+(r.blockSeconds||0),0);
        const totalDriveSec = rows.reduce((s,r)=>s+(r.driveSeconds||0),0);
        const totalPitSec = totalTimeSec - totalDriveSec;

        const maxStdLaps = rows.reduce((max,r)=>{
          if (String(r.label).startsWith("Last")) return max;
          return Math.max(max, r.laps);
        },0);

        const avgVELap = totalLaps ? totalVe/totalLaps : 0;
        const baseline = 4.5;
        const deltaVe  = avgVELap - baseline;

        const theoreticalLeft = veTotal - cfg.laps * cfg.veTarget;

        let stdLapTime = baseLapTime;
        if (code === "A") stdLapTime = planA_lap;
        else if (code === "B") stdLapTime = planB_lap;
        else stdLapTime = planC_lap;

        return {
          totalLaps, totalVe, avgVELap, deltaVe, theoreticalLeft,
          totalStints: rows.length, totalDriveSec, totalPitSec, totalTimeSec,
          maxStdLaps, stdLapTime
        };
      };

      const statsA = getPlanStats("A");
      const statsB = getPlanStats("B");
      const statsC = getPlanStats("C");

      /* ------------------------------------------------------------
         GOOGLE SHEETS COLOR SCRIPT (TEXT)
      -------------------------------------------------------------*/

      const googleSheetsColorScript = `
function applyRaceplanColors() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const values = sheet.getDataRange().getValues();

  const STINT_COL       = 1;   // A
  const LAPTIME_COL     = 2;   // B
  const VETARGET_COL    = 3;   // C
  const VEUSED_COL      = 4;   // D
  const PITTIME_COL     = 5;   // E
  const TYRECHANGE_COL  = 6;   // F
  const COMPOUND_COL    = 7;   // G
  const TYRESET_COL     = 8;   // H
  const LAPS_COL        = 9;   // I
  const STINTLEN_COL    = 10;  // J
  const DRIVER_COL      = 11;  // K
  const GAME_COL        = 12;  // L
  const UTC_COL         = 13;  // M
  const DRIVER_A_COL    = 14;  // N
  const DRIVER_B_COL    = 15;  // O
  const DRIVER_C_COL    = 16;  // P
  const DRIVER_D_COL    = 17;  // Q
  const AVAIL_COL       = 18;  // R
  const MAYBE_COL       = 19;  // S
  const UNAVAIL_COL     = 20;  // T

  const COLORS = {
    yes:         "#00C853",
    no:          "#D50000",
    soft:        "#FF0000",
    medium:      "#FFD700",
    hard:        "#BFBFBF",
    wet:         "#0070C0",
    driverA:     "#00FF00",
    driverB:     "#FFFF00",
    driverC:     "#FF0000",
    driverD:     "#00FFFF",
    gameBand:    "#00B8D9",
    utcBand:     "#00B8D9",
    available:   "#00C853",
    maybe:       "#FFFF00",
    unavailable: "#FF0000"
  };

  sheet.getRange(1, DRIVER_A_COL).setBackground(COLORS.driverA);
  sheet.getRange(1, DRIVER_B_COL).setBackground(COLORS.driverB);
  sheet.getRange(1, DRIVER_C_COL).setBackground(COLORS.driverC);
  sheet.getRange(1, DRIVER_D_COL).setBackground(COLORS.driverD);

  for (let r = 3; r <= values.length; r++) {
    const row = values[r - 1];

    const tyreChange = String(row[TYRECHANGE_COL - 1] || "").toLowerCase();
    const compound   = String(row[COMPOUND_COL    - 1] || "").toLowerCase();
    const driver     = String(row[DRIVER_COL      - 1] || "").trim();

    if (tyreChange === "yes") sheet.getRange(r, TYRECHANGE_COL).setBackground(COLORS.yes);
    else if (tyreChange === "no") sheet.getRange(r, TYRECHANGE_COL).setBackground(COLORS.no);

    if (compound.includes("soft")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.soft);
    else if (compound.includes("medium")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.medium);
    else if (compound.includes("hard")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.hard);
    else if (compound.includes("wet")) sheet.getRange(r, COMPOUND_COL).setBackground(COLORS.wet);

    const nameA = String(values[0][DRIVER_A_COL - 1] || "").trim();
    const nameB = String(values[0][DRIVER_B_COL - 1] || "").trim();
    const nameC = String(values[0][DRIVER_C_COL - 1] || "").trim();
    const nameD = String(values[0][DRIVER_D_COL - 1] || "").trim();

    if (driver && driver === nameA) sheet.getRange(r, DRIVER_A_COL).setBackground(COLORS.driverA);
    if (driver && driver === nameB) sheet.getRange(r, DRIVER_B_COL).setBackground(COLORS.driverB);
    if (driver && driver === nameC) sheet.getRange(r, DRIVER_C_COL).setBackground(COLORS.driverC);
    if (driver && driver === nameD) sheet.getRange(r, DRIVER_D_COL).setBackground(COLORS.driverD);

    if (row[GAME_COL - 1]) sheet.getRange(r, GAME_COL).setBackground(COLORS.gameBand);
    if (row[UTC_COL - 1]) sheet.getRange(r, UTC_COL).setBackground(COLORS.utcBand);
  }

  for (let r = 1; r <= values.length; r++) {
    const row = values[r - 1];
    const a = String(row[AVAIL_COL  - 1] || "").toLowerCase();
    const m = String(row[MAYBE_COL  - 1] || "").toLowerCase();
    const u = String(row[UNAVAIL_COL- 1] || "").toLowerCase();

    if (a === "available" || a === "a") sheet.getRange(r, AVAIL_COL).setBackground(COLORS.available);
    if (m === "maybe" || m === "m") sheet.getRange(r, MAYBE_COL).setBackground(COLORS.maybe);
    if (u === "unavailable" || u === "u") sheet.getRange(r, UNAVAIL_COL).setBackground(COLORS.unavailable);
  }
}
      `.trim();

      const copyColorScriptToClipboard = () => {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard
            .writeText(googleSheetsColorScript)
            .then(() => alert("Apps Script copied! Paste into Extensions → Apps Script in your Sheet."))
            .catch(() => alert("Clipboard blocked. Please copy manually."));
        } else {
          alert("Clipboard not available. Please copy manually.");
        }
      };

      /* ------------------------------------------------------------
         OUTLINE ROWS + TIMED ROWS
      -------------------------------------------------------------*/

      const { rows: outlineRows, warning: currentPlanWarning } = buildPlanOutline(plan);

      let gameMinForRows = timeToMin(gameStart);
      let utcMinForRows  = timeToMin(utcStart);
      const timedRows = outlineRows.map((r) => {
        const startGame = gameMinForRows;
        const startUtc  = utcMinForRows;
        const blockMin  = (r.blockSeconds || 0) / 60;
        gameMinForRows += blockMin;
        utcMinForRows  += blockMin;
        return {
          ...r,
          _gameStart: minToTime(Math.round(startGame)),
          _utcStart:  minToTime(Math.round(startUtc))
        };
      });

      /* ------------------------------------------------------------
         CSV EXPORT FOR GOOGLE SHEETS
      -------------------------------------------------------------*/

      const exportCSV = () => {
        if (!timedRows.length) {
          alert("Nothing to export — no stints generated.");
          return;
        }

        let csv = [
          "Stint #",
          "Lap Time Target",
          "VE Target (%/lap)",
          "VE Used (%)",
          "Pit Time (s)",
          "Tyre Change",
          "Tyre Compound",
          "Tyre Set #",
          "Laps",
          "Stint Length (min)",
          "Driver",
          "Game EST Start Time",
          "UTC Start Time",
          "Driver A",
          "Driver B",
          "Driver C",
          "Driver D",
          "Available",
          "Maybe",
          "Unavailable"
        ].join(";") + "\n";

        csv += "Quali;;;;;;;;;;;;;;;;;;;\n";

        timedRows.forEach((r) => {
          const key = `${plan}-${r.stintIndex}`;
          const driver = (driverNames[key] || "").replace(/;/g, ",");

          const lapTimeTxt  = "'" + formatLap(r.lapTimeTarget);
          const veTargetTxt = r.veTarget.toFixed(2).replace(".", ",");
          const veUsedTxt   = r.veUsed.toFixed(2).replace(".", ",");
          const pitTxt      = r.pitTime.toFixed(2).replace(".", ",");
          const stintMin    = ((r.driveSeconds + r.outPenaltySeconds) / 60).toFixed(1).replace(".", ",");

          const line = [
            r.label,
            lapTimeTxt,
            veTargetTxt,
            veUsedTxt,
            pitTxt,
            r.tyreChange,
            r.compound,
            r.tyreSet,
            r.laps,
            stintMin,
            driver,
            r._gameStart,
            r._utcStart,
            "", "", "", "",
            "", "", ""
          ].join(";");

          csv += line + "\n";
        });

        const blob = new Blob([csv], { type:"text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Raceplan_${plan}_GoogleSheets.csv`;
        link.click();
      };

      /* ------------------------------------------------------------
         UI
      -------------------------------------------------------------*/

      const planChip = (p) => {
        if (p === "A") return { cls: "btn-lime", label: "Plan A" };
        if (p === "B") return { cls: "btn-mag",  label: "Plan B" };
        return { cls: "btn-cyan", label: "Plan C" };
      };

      return (
        <div className="p-4 flex flex-col lg:flex-row gap-5">

          {/* LEFT CONTROL PANEL */}
          <div className="w-full lg:w-1/3 space-y-4">

            {/* BASE SETTINGS */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">
                  Base Settings
                  <span className="hud-chip">HUD</span>
                </div>
                <span className="tag"><span className="dot" style={{background:"var(--lime)"}}></span>VE / Pace</span>
              </div>
              <div className="hud-body space-y-3">
                <div className="hud-grid cols2">
                  <div>
                    <div className="hud-label">Lap Time (m:ss.sss)</div>
                    <input
                      value={lapTimeStr}
                      onChange={handleLapTimeChange}
                      className="hud-input w-full"
                    />
                    <div className="hud-help mt-1">{lapTimeSec.toFixed(3)} s</div>
                  </div>
                  <div>
                    <div className="hud-label">Race Duration (H:MM:SS)</div>
                    <input
                      value={raceDurationStr}
                      onChange={handleRaceTimeChange}
                      className="hud-input w-full"
                    />
                    <div className="hud-help mt-1">{(raceDurationSec/3600).toFixed(2)} h</div>
                  </div>
                </div>

                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">Tank VE (%)</div>
                    <input
                      type="number"
                      value={veTotal}
                      disabled
                      className="hud-input w-full"
                    />
                  </div>
                  <div>
                    <div className="hud-label">Use per Lap</div>
                    <input
                      type="number"
                      value={vePerLap}
                      onChange={(e)=>setVePerLap(parseFloat(e.target.value)||0)}
                      className="hud-input w-full"
                    />
                  </div>
                  <div>
                    <div className="hud-label">Safety Buffer</div>
                    <input
                      type="number"
                      value={safetyBuffer}
                      onChange={(e)=>setSafetyBuffer(parseFloat(e.target.value)||0)}
                      className="hud-input w-full"
                    />
                  </div>
                </div>

                <div>
                  <div className="hud-label">Tyre Deg (s/lap/lap)</div>
                  <input
                    type="number"
                    step="0.001"
                    value={tyreDeg}
                    onChange={(e)=>setTyreDeg(parseFloat(e.target.value)||0)}
                    className="hud-input w-full"
                  />
                </div>

                {/* ✅ Plan B/C delta adjustability */}
                <div className="hud-card" style={{background:"rgba(0,0,0,0.22)", boxShadow:"none", borderRadius:"14px"}}>
                  <div className="hud-body">
                    <div className="hud-title" style={{fontSize:"10px", marginBottom:"8px"}}>
                      Plan Pace Deltas (s/lap)
                    </div>
                    <div className="hud-grid cols2">
                      <div>
                        <div className="hud-label">Plan B Delta</div>
                        <input
                          type="number"
                          step="0.05"
                          value={pacePenaltyB}
                          onChange={(e)=>setPacePenaltyB(parseFloat(e.target.value)||0)}
                          className="hud-input w-full"
                        />
                        <div className="hud-help mt-1">Added to base lap time for Plan B.</div>
                      </div>
                      <div>
                        <div className="hud-label">Plan C Delta</div>
                        <input
                          type="number"
                          step="0.05"
                          value={pacePenaltyC}
                          onChange={(e)=>setPacePenaltyC(parseFloat(e.target.value)||0)}
                          className="hud-input w-full"
                        />
                        <div className="hud-help mt-1">Added to base lap time for Plan C.</div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            {/* COMPOUND DELTAS */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Tyre Compound Deltas</div>
                <span className="tag"><span className="dot" style={{background:"var(--mag)"}}></span>s/lap</span>
              </div>
              <div className="hud-body space-y-2">
                {["Soft","Medium","Hard","Wet"].map((c)=>(
                  <div key={c} className="flex items-center gap-2">
                    <div className="hud-label w-20">{c}</div>
                    <input
                      type="number"
                      step="0.05"
                      value={compoundDeltas[c]}
                      onChange={(e)=>setCompoundDeltas({
                        ...compoundDeltas,
                        [c]: parseFloat(e.target.value)||0
                      })}
                      className="hud-input flex-1"
                    />
                  </div>
                ))}
              </div>
            </div>

            {/* PIT & TIME LOSSES */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Pit & Time Loss</div>
                <span className="tag"><span className="dot" style={{background:"var(--cyan)"}}></span>seconds</span>
              </div>
              <div className="hud-body space-y-3">
                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">Base Pit (s)</div>
                    <input type="number" value={basePit} onChange={(e)=>setBasePit(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Tyre Change (s)</div>
                    <input type="number" value={tyreChangeTime} onChange={(e)=>setTyreChangeTime(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Fuel (s/%VE)</div>
                    <input type="number" value={fuelRate} onChange={(e)=>setFuelRate(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                </div>

                <div className="hud-grid cols3">
                  <div>
                    <div className="hud-label">In-lap Loss</div>
                    <input type="number" value={inLapLoss} onChange={(e)=>setInLapLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Out-lap Loss</div>
                    <input type="number" value={outLapLoss} onChange={(e)=>setOutLapLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                  <div>
                    <div className="hud-label">Warmup (tyres)</div>
                    <input type="number" value={warmupLoss} onChange={(e)=>setWarmupLoss(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                  </div>
                </div>

                <div>
                  <div className="hud-label">First Lap Penalty (s)</div>
                  <input type="number" value={firstLapPenalty} onChange={(e)=>setFirstLapPenalty(parseFloat(e.target.value)||0)} className="hud-input w-full" />
                </div>
              </div>
            </div>

            {/* START TIMES */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Session Start Times</div>
                <span className="tag"><span className="dot" style={{background:"var(--lime)"}}></span>clock</span>
              </div>
              <div className="hud-body space-y-3">
                <div>
                  <div className="hud-label">Game Start Time</div>
                  <input type="time" value={gameStart} onChange={(e)=>setGameStart(e.target.value)} className="hud-input w-full" />
                </div>
                <div>
                  <div className="hud-label">EST Start Time UTC</div>
                  <input type="time" value={utcStart} onChange={(e)=>setUtcStart(e.target.value)} className="hud-input w-full" />
                  <div className="hud-help mt-1">EST = Estimated Start (UTC). Adjust for official timetable.</div>
                </div>
              </div>
            </div>

          </div>

          {/* RIGHT MAIN PANEL */}
          <div className="w-full lg:w-2/3 space-y-4">

            {/* PLAN SUMMARY */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Plan Comparison Summary</div>
                <span className="hud-chip">A / B / C</span>
              </div>
              <div className="hud-body">
                <div className="overflow-x-auto">
                  <table className="hud-table">
                    <thead>
                      <tr>
                        <th className="hud-th">Metric</th>
                        <th className="hud-th" style={{color:"rgba(124,255,91,0.9)"}}>Plan A</th>
                        <th className="hud-th" style={{color:"rgba(255,56,209,0.9)"}}>Plan B</th>
                        <th className="hud-th" style={{color:"rgba(54,215,255,0.9)"}}>Plan C</th>
                      </tr>
                    </thead>
                    <tbody>
                      {[
                        ["Total race laps", statsA.totalLaps, statsB.totalLaps, statsC.totalLaps],
                        ["Max standard stint laps", statsA.maxStdLaps, statsB.maxStdLaps, statsC.maxStdLaps],
                        ["Avg VE / lap (outline)", statsA.avgVELap.toFixed(3), statsB.avgVELap.toFixed(3), statsC.avgVELap.toFixed(3)],
                        ["Theoretical VE left (std stint)", statsA.theoreticalLeft.toFixed(2), statsB.theoreticalLeft.toFixed(2), statsC.theoreticalLeft.toFixed(2)],
                        ["Std stint lap time (s)", statsA.stdLapTime.toFixed(3), statsB.stdLapTime.toFixed(3), statsC.stdLapTime.toFixed(3)],
                        ["Total stints", statsA.totalStints, statsB.totalStints, statsC.totalStints],
                        ["Drive time (min)", (statsA.totalDriveSec/60).toFixed(1), (statsB.totalDriveSec/60).toFixed(1), (statsC.totalDriveSec/60).toFixed(1)],
                        ["Pit time (min)", (statsA.totalPitSec/60).toFixed(1), (statsB.totalPitSec/60).toFixed(1), (statsC.totalPitSec/60).toFixed(1)],
                        ["Total time (min)", (statsA.totalTimeSec/60).toFixed(1), (statsB.totalTimeSec/60).toFixed(1), (statsC.totalTimeSec/60).toFixed(1)],
                      ].map((row, i)=>(
                        <tr key={i}>
                          <td className="hud-td">{row[0]}</td>
                          <td className="hud-td">{row[1]}</td>
                          <td className="hud-td">{row[2]}</td>
                          <td className="hud-td">{row[3]}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="hud-help mt-2">
                  Final stint always adjusted so the race duration is fully covered without exceeding 100% VE.
                </div>
              </div>
            </div>

            {/* FINAL STINT STRATEGY */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Final Stint Strategy</div>
                <span className="tag"><span className="dot" style={{background:"var(--amber)"}}></span>last stint</span>
              </div>
              <div className="hud-body space-y-3">
                <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                  <div className="space-y-2 text-sm">
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        className="accent-[var(--lime)]"
                        checked={finalStintMode === "pit"}
                        onChange={()=>setFinalStintMode("pit")}
                      />
                      <span>Auto extend pit time if last stint can't finish within 100% VE.</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        className="accent-[var(--lime)]"
                        checked={finalStintMode === "save"}
                        onChange={()=>setFinalStintMode("save")}
                      />
                      <span>Try Super-Save VE% on last stint first, then extend pit if still needed.</span>
                    </label>
                  </div>
                  <div className="text-sm">
                    <div className="hud-label mb-1">Max Super-Save Reduction (%)</div>
                    <input
                      type="number"
                      min={0}
                      max={50}
                      value={maxSavePercent}
                      disabled={finalStintMode !== "save"}
                      onChange={(e)=>{
                        const v = parseFloat(e.target.value);
                        const clamped = Math.max(0, Math.min(50, isNaN(v)?0:v));
                        setMaxSavePercent(clamped);
                      }}
                      className="hud-input w-24"
                    />
                    <div className="hud-help mt-1">Only affects the last stint in Super-Save mode.</div>
                  </div>
                </div>
              </div>
            </div>

            {/* ✅ MOVED: PLAN MENU now under Final Stint Strategy, above Stint Outline */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Plan</div>
                <span className="hud-chip">Select + Export</span>
              </div>
              <div className="hud-body flex flex-wrap items-center gap-2">
                {["A","B","C"].map((p)=>{
                  const meta = planChip(p);
                  return (
                    <button
                      key={p}
                      onClick={()=>setPlan(p)}
                      className={`hud-btn ${meta.cls} ${plan===p ? "active" : ""}`}
                      title={meta.label}
                    >
                      {p}
                    </button>
                  );
                })}

                <div className="ml-auto flex items-center gap-2">
                  <button
                    onClick={exportCSV}
                    className="hud-btn btn-cyan"
                  >
                    Export CSV
                  </button>
                </div>
              </div>
            </div>

            {/* OUTLINE TABLE */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Stint Outline</div>
                <span className="tag"><span className="dot" style={{background:"var(--lime)"}}></span>Plan {plan}</span>
              </div>
              <div className="hud-body">
                <div className="overflow-x-auto">
                  <table className="hud-table">
                    <thead>
                      <tr>
                        <th className="hud-th">Stint</th>
                        <th className="hud-th">Lap Target</th>
                        <th className="hud-th">VE Tgt</th>
                        <th className="hud-th">VE Used</th>
                        <th className="hud-th">Pit</th>
                        <th className="hud-th">Tyre</th>
                        <th className="hud-th">Compound</th>
                        <th className="hud-th">Set</th>
                        <th className="hud-th">Laps</th>
                        <th className="hud-th">Len (min)</th>
                        <th className="hud-th">Driver</th>
                        <th className="hud-th">Game</th>
                        <th className="hud-th">UTC</th>
                      </tr>
                    </thead>

                    <tbody>
                      {timedRows.map((r)=>{
                        const key = `${plan}-${r.stintIndex}`;
                        const stintMins = ((r.driveSeconds + r.outPenaltySeconds)/60).toFixed(1);
                        const isNoChange = r.stintIndex !== 1 && r.tyreChange === "No";
                        const compoundValue = stintCompounds[key] || r.compound;

                        return (
                          <tr key={key}>
                            <td className="hud-td">{r.label}</td>
                            <td className="hud-td">{formatLap(r.lapTimeTarget)}</td>
                            <td className="hud-td">{r.veTarget.toFixed(2)}</td>
                            <td className="hud-td">{r.veUsed.toFixed(2)}</td>
                            <td className="hud-td">{r.pitTime.toFixed(2)}</td>
                            <td className="hud-td">
                              <button
                                onClick={()=>toggleTyreChange(plan, r.stintIndex, r.tyreChange)}
                                className={
                                  "hud-btn " + (r.tyreChange==="Yes" ? "btn-lime" : "btn-mag")
                                }
                                style={{padding:"6px 10px", fontSize:"10px"}}
                              >
                                {r.tyreChange}
                              </button>
                            </td>
                            <td className="hud-td">
                              <select
                                value={compoundValue}
                                disabled={isNoChange}
                                onChange={(e)=>setStintCompound(plan,r.stintIndex,e.target.value)}
                                className={
                                  "hud-select w-full " +
                                  compoundClass(compoundValue) +
                                  (isNoChange ? " opacity-60 cursor-not-allowed" : "")
                                }
                              >
                                <option value="Soft">Soft</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                                <option value="Wet">Wet</option>
                              </select>
                            </td>
                            <td className="hud-td">{r.tyreSet}</td>
                            <td className="hud-td">{r.laps}</td>
                            <td className="hud-td">{stintMins}</td>
                            <td className="hud-td">
                              <input
                                type="text"
                                value={driverNames[key] || ""}
                                onChange={(e)=>setStintDriver(plan,r.stintIndex,e.target.value)}
                                className="hud-input w-28"
                                placeholder="Name"
                              />
                            </td>
                            <td className="hud-td">{r._gameStart}</td>
                            <td className="hud-td">{r._utcStart}</td>
                          </tr>
                        );
                      })}

                      {!timedRows.length && (
                        <tr>
                          <td colSpan={13} className="hud-td" style={{textAlign:"center", color:"rgba(180,200,220,0.6)"}}>
                            Enter VE, lap time and race duration to generate outline.
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>

                {currentPlanWarning && (
                  <div className="warn mt-3">⚠ {currentPlanWarning}</div>
                )}
              </div>
            </div>

            {/* GOOGLE SHEETS COLOR HELP */}
            <div className="hud-card">
              <div className="hud-head">
                <div className="hud-title">Google Sheets Coloring</div>
                <button
                  onClick={()=>setShowGsHelp(v=>!v)}
                  className="hud-btn btn-mag"
                  style={{padding:"7px 10px"}}
                >
                  {showGsHelp ? "Hide" : "Show"}
                </button>
              </div>

              <div className="hud-body">
                <div className="hud-help" style={{fontSize:"12px"}}>
                  Auto-color tyre changes, compounds, drivers & availability
                </div>

                {showGsHelp && (
                  <div className="mt-3 space-y-3">
                    <ol className="list-decimal list-inside space-y-1" style={{color:"rgba(235,245,255,0.86)"}}>
                      <li>Click <b>Export CSV</b>.</li>
                      <li>Import CSV into a new Google Sheet (separator = <b>semicolon</b>).</li>
                      <li>Go to <b>Extensions → Apps Script</b>.</li>
                      <li>Delete everything and paste the script below.</li>
                      <li>In row 1, columns N–Q, type your Driver A–D names.</li>
                      <li>Run <code>applyRaceplanColors()</code>.</li>
                    </ol>

                    <div>
                      <div className="flex items-center justify-between mb-2">
                        <span className="hud-label">Apps Script</span>
                        <button
                          onClick={copyColorScriptToClipboard}
                          className="hud-btn btn-lime"
                          style={{padding:"7px 10px"}}
                        >
                          Copy Script
                        </button>
                      </div>
                      <textarea
                        readOnly
                        className="hud-input w-full"
                        style={{height:"180px", fontFamily:"ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace", fontSize:"11px"}}
                        value={googleSheetsColorScript}
                      />
                    </div>
                  </div>
                )}
              </div>
            </div>

          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<RacePlanner />);
  </script>
</body>
</html>
